# yolov5l_fusion_FLIR_p3_bcam.yaml
# Single BCAM at P3 only
nc: 3
depth_multiple: 1.00
width_multiple: 1.00

anchors:
  - [10,13, 16,30, 33,23]
  - [30,61, 62,45, 59,119]
  - [116,90, 156,198, 373,326]

backbone:
  [
    ######### Dual Streams #########
    # RGB stream
    [ -1, 1, Focus, [64, 3] ],             # 0
    [ -1, 1, Conv, [128, 3, 2] ],          # 1
    [ -1, 3, C3, [128] ],                  # 2
    [ -1, 1, Conv, [256, 3, 2] ],          # 3
    [ -1, 9, C3, [256] ],                  # 4 - RGB P3
    [ -1, 1, Conv, [512, 3, 2] ],          # 5
    [ -1, 9, C3, [512] ],                  # 6 - RGB P4
    [ -1, 1, Conv, [1024, 3, 2] ],         # 7
    [ -1, 1, SPP, [1024, [5, 9, 13]] ],    # 8
    [ -1, 3, C3, [1024, False] ],          # 9 - RGB P5

    # Thermal stream
    [ -4, 1, Focus, [64, 3] ],             # 10
    [ -1, 1, Conv, [128, 3, 2] ],          # 11
    [ -1, 3, C3, [128] ],                  # 12
    [ -1, 1, Conv, [256, 3, 2] ],          # 13
    [ -1, 9, C3, [256] ],                  # 14 - T P3
    [ -1, 1, Conv, [512, 3, 2] ],          # 15
    [ -1, 9, C3, [512] ],                  # 16 - T P4
    [ -1, 1, Conv, [1024, 3, 2] ],         # 17
    [ -1, 1, SPP, [1024, [5, 9, 13]] ],    # 18
    [ -1, 3, C3, [1024, False] ],          # 19 - T P5

    ######### Fusion #########
    # P5 fusion (simple elementwise or concat+conv)
    [ [9, 19], 1, Concat, [1] ],           # 20
    [ -1, 1, Conv, [1024, 1, 1] ],         # 21 fused P5

    # P4 fusion (simple elementwise or concat+conv)
    [ [6, 16], 1, Concat, [1] ],           # 22
    [ -1, 1, Conv, [512, 1, 1] ],          # 23 fused P4

    # P3 fusion â†’ BCAM
    [ [4, 14], 1, BCAM_SingleOutput, [256] ],  # 24 fused P3 with BCAM
  ]

head:
  [
    # Head path P5
    [21, 1, Conv, [512, 1, 1]],            # 25
    [-1, 1, nn.Upsample, [None, 2, 'nearest']],  # 26 upsample P5

    # Head path P4
    [23, 1, Conv, [256, 1, 1]],            # 27
    [[26, 27], 1, Concat, [1]],            # 28
    [-1, 3, C3, [512, False]],             # 29 P4

    # Head path P3 (BCAM fused)
    [24, 1, Conv, [256, 1, 1]],            # 30
    [-1, 1, nn.Upsample, [None, 2, 'nearest']],  # 31
    [[31, 24], 1, Concat, [1]],            # 32
    [-1, 3, C3, [256, False]],             # 33 P3

    # Downsample paths
    [-1, 1, Conv, [256, 3, 2]],            # 34
    [[34, 29], 1, Concat, [1]],            # 35
    [-1, 3, C3, [512, False]],             # 36 P4

    [-1, 1, Conv, [512, 3, 2]],            # 37
    [[37, 25], 1, Concat, [1]],            # 38
    [-1, 3, C3, [1024, False]],            # 39 P5

    [[33, 36, 39], 1, Detect, [nc, anchors]],
  ]
